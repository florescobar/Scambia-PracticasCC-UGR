
pipeline {
    agent any

    environment {
        // Configura las variables de entorno necesarias para tu proyecto Laravel
        APP_ENV = 'testing'
    }

    stages {
        stage('Clonar Repositorio') {
            steps {
                // Clonar el repositorio desde tu sistema de control de versiones
                git 'https://github.com/florescobar/Scambia-PracticasCC-UGR.git'
            }
        }

        stage('Instalar Dependencias y Configurar Entorno') {
            steps {
                // Descargar e instalar Composer
                sh '''
                    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
                    php -r "if (hash_file('sha384', 'composer-setup.php') === 'EXPECTED_HASH') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
                    php composer-setup.php
                    php -r "unlink('composer-setup.php');"
                '''

                // Instalar dependencias de Laravel usando Composer
                sh 'php composer.phar install --no-interaction --prefer-dist'

                // Configurar el archivo .env
                sh 'cp .env.example .env'
                sh 'php artisan key:generate'
            }
        }

        stage('Ejecutar Pruebas') {
            steps {
                // Ejecutar pruebas PHPUnit
                sh 'php artisan test'
            }
        }

        // Otros pasos seg√∫n tus necesidades...

    }

    post {
        success {
            // Acciones a realizar si las pruebas son exitosas
            echo 'Las pruebas PHPUnit han pasado exitosamente.'
        }

        failure {
            // Acciones a realizar si las pruebas fallan
            echo 'Las pruebas PHPUnit han fallado. Por favor, revisa y corrige los problemas.'
        }
    }
}
